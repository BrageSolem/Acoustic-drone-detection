<!DOCTYPE html>
<html lang="en">
<head>
    <title>Drone Detection Network</title>
    <script src="/socket.io/socket.io.js"></script>

    <!-- Leaflet CSS -->
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
        body {
            margin: 0;
            font-family: Arial;
            display: flex;
            height: 100vh;
            background: #f2f2f2;
        }

        .sidebar {
            width: 20%;
            background: #ddd;
            padding: 20px;
            overflow-y: auto;
        }

        .center {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        #map {
            width: 100%;
            height: 50%;
            margin-bottom: 20px;
        }

        .video {
            width: 70%;
            height: 30%;
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drone-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        button {
            margin-top: 15px;
            padding: 8px;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>Noise Sounds List</h3>
    <div>Bird</div>
    <div>Plane</div>
    <div>Wind</div>
</div>

<div class="center">
    <div id="map"></div>
    <div class="video">VIDEO FEED</div>
    <button onclick="addDrone()">Simulate Drone Detection</button>
</div>

<div class="sidebar">
    <h3>Identified Drones</h3>
    <div id="droneList"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const socket = io();
    let drones = [];
    let markers = [];

    // ---- Initialize Map ----
    showMyLocation();



    // ---- Socket Events ----
    socket.on("initData", (data) => {
        drones = data.drones;
        render();
    });

    socket.on("updateDrones", (data) => {
        drones = data;
        render();
    });

    // Reusable function to get current position
    function getCurrentPosition(options = {}) {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error("Geolocation is not supported by this browser."));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    resolve({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    });
                },
                (error) => {
                    reject(error);
                },
                options
            );
        });
    }

    async function showMyLocation() {
        try {
            const position = await getCurrentPosition();

            if (!position || !position.lat || !position.lng) {
                throw new Error("Invalid location data");
            }

            const map = L.map('map').setView([position.lat, position.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            L.marker([position.lat, position.lng])
                .addTo(map)
                .bindPopup("You are here!")
                .openPopup();

        } catch (error) {
            console.error("Location error:", error.message);
        }
    }


    async function addDrone() { // ---- Simulate Drone Detection ----

        const position = await getCurrentPosition()
        const dronelat = position.lat + (Math.random() - 0.5) * 0.02;
        const dronelng = position.lng + (Math.random() - 0.5) * 0.02;

        const newDrone = {
            id: "Drone_" + Math.floor(Math.random() * 1000),
            type: "Type A",
            time: new Date().toLocaleTimeString(),
            lat: dronelat,
            lng: dronelng
        };
        L.marker([newDrone.lat, newDrone.lng])
            .addTo(map)
            .bindPopup("Drone:"+newDrone.id)
            .openPopup();

        socket.emit("newDrone", newDrone);
    }

    // ---- Render Function ----
    function render() {
        const list = document.getElementById("droneList");
        list.innerHTML = "";

        // Remove old markers
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        drones.forEach(d => {
            // Sidebar list
            const div = document.createElement("div");
            div.className = "drone-item";
            div.innerHTML = `<span>${d.id}</span><span>${d.time}</span>`;
            list.appendChild(div);

            // Map marker
            if (d.lat && d.lng) {
                const marker = L.marker([d.lat, d.lng])
                    .addTo(map)
                    .bindPopup(`<b>${d.id}</b><br>${d.time}`);

                markers.push(marker);
            }
        });
    }
</script>

</body>
</html>
